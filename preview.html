<!doctype html>
<html lang="zh-CN" data-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TEXT_STORE_KV - Preview</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,400&family=JetBrains+Mono:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <style>
      /* ============================================================
   CSS Variables / Theming
   ============================================================ */
      :root {
        --font-ui: "DM Sans", system-ui, sans-serif;
        --font-mono: "JetBrains Mono", "Fira Code", "Cascadia Code", monospace;
        --sidebar-width: 320px;
        --header-height: auto;
        --radius-sm: 4px;
        --radius-md: 8px;
        --radius-lg: 12px;
        --transition: 0.2s ease;
        --transition-fast: 0.12s ease;
      }

      [data-theme="dark"] {
        --bg-root: #0d1117;
        --bg-surface: #161b22;
        --bg-elevated: #1c2128;
        --bg-overlay: #21262d;
        --bg-input: #0d1117;
        --border: #30363d;
        --border-muted: #21262d;
        --text-primary: #e6edf3;
        --text-secondary: #8b949e;
        --text-tertiary: #6e7681;
        --accent: #58a6ff;
        --accent-muted: rgba(88, 166, 255, 0.15);
        --accent-hover: rgba(88, 166, 255, 0.08);
        --success: #3fb950;
        --success-muted: rgba(63, 185, 80, 0.15);
        --warning: #d29922;
        --warning-muted: rgba(210, 153, 34, 0.15);
        --danger: #f85149;
        --danger-muted: rgba(248, 81, 73, 0.15);
        --scrollbar-thumb: #30363d;
        --scrollbar-track: transparent;
        --shadow: 0 1px 3px rgba(0, 0, 0, 0.4), 0 1px 2px rgba(0, 0, 0, 0.3);
        --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
        --backdrop: rgba(0, 0, 0, 0.6);
      }

      [data-theme="light"] {
        --bg-root: #f6f8fa;
        --bg-surface: #ffffff;
        --bg-elevated: #ffffff;
        --bg-overlay: #f6f8fa;
        --bg-input: #ffffff;
        --border: #d0d7de;
        --border-muted: #e8ecf0;
        --text-primary: #24292f;
        --text-secondary: #57606a;
        --text-tertiary: #8c959f;
        --accent: #0969da;
        --accent-muted: rgba(9, 105, 218, 0.1);
        --accent-hover: rgba(9, 105, 218, 0.05);
        --success: #1a7f37;
        --success-muted: rgba(26, 127, 55, 0.1);
        --warning: #9a6700;
        --warning-muted: rgba(154, 103, 0, 0.1);
        --danger: #cf222e;
        --danger-muted: rgba(207, 34, 46, 0.1);
        --scrollbar-thumb: #d0d7de;
        --scrollbar-track: transparent;
        --shadow: 0 1px 3px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.06);
        --backdrop: rgba(0, 0, 0, 0.3);
      }

      /* ============================================================
   Reset & Base
   ============================================================ */
      *,
      *::before,
      *::after {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html,
      body {
        height: 100%;
        overflow: hidden;
        overscroll-behavior: none;
      }

      body {
        font-family: var(--font-ui);
        background: var(--bg-root);
        color: var(--text-primary);
        line-height: 1.5;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      /* Scrollbar */
      ::-webkit-scrollbar {
        width: 6px;
        height: 6px;
      }
      ::-webkit-scrollbar-track {
        background: var(--scrollbar-track);
      }
      ::-webkit-scrollbar-thumb {
        background: var(--scrollbar-thumb);
        border-radius: 3px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: var(--text-tertiary);
      }

      /* ============================================================
   Layout Shell
   ============================================================ */
      .app-shell {
        display: flex;
        flex-direction: column;
        height: 100vh;
        height: 100dvh;
      }

      .app-header {
        height: var(--header-height);
        background: var(--bg-surface);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        padding: 10px 16px;
        gap: 8px;
        flex-shrink: 0;
        z-index: 100;
      }

      .app-body {
        display: flex;
        flex: 1;
        min-height: 0;
      }

      /* ============================================================
   Header
   ============================================================ */
      .header-row-1 {
        display: flex;
        align-items: center;
        gap: 8px;
        width: 100%;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 0;
        flex: 1;
      }

      .btn-menu {
        display: none;
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 6px;
        border-radius: var(--radius-sm);
        transition:
          background var(--transition-fast),
          color var(--transition-fast);
        flex-shrink: 0;
      }
      .btn-menu:hover {
        background: var(--accent-hover);
        color: var(--text-primary);
      }

      .app-logo {
        font-family: var(--font-mono);
        font-weight: 600;
        font-size: 15px;
        letter-spacing: -0.3px;
        color: var(--text-primary);
        white-space: nowrap;
        user-select: none;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--success);
        flex-shrink: 0;
        box-shadow: 0 0 6px rgba(63, 185, 80, 0.4);
        animation: pulse-dot 2.5s ease-in-out infinite;
      }

      @keyframes pulse-dot {
        0%,
        100% {
          opacity: 1;
          box-shadow: 0 0 6px rgba(63, 185, 80, 0.4);
        }
        50% {
          opacity: 0.6;
          box-shadow: 0 0 2px rgba(63, 185, 80, 0.2);
        }
      }

      .header-spacer {
        flex: 1;
      }

      .header-right {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      /* ============================================================
   Buttons
   ============================================================ */
      .btn-icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 34px;
        height: 34px;
        border: none;
        background: none;
        color: var(--text-secondary);
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition:
          background var(--transition-fast),
          color var(--transition-fast);
        flex-shrink: 0;
      }
      .btn-icon:hover {
        background: var(--accent-hover);
        color: var(--text-primary);
      }
      .btn-icon svg {
        width: 18px;
        height: 18px;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        height: 34px;
        padding: 0 14px;
        border: 1px solid var(--border);
        background: var(--bg-elevated);
        color: var(--text-primary);
        border-radius: var(--radius-md);
        cursor: pointer;
        font-family: var(--font-ui);
        font-size: 13px;
        font-weight: 500;
        transition:
          background var(--transition-fast),
          border-color var(--transition-fast),
          transform var(--transition-fast);
        white-space: nowrap;
        user-select: none;
      }
      .btn:hover {
        background: var(--bg-overlay);
        border-color: var(--text-tertiary);
      }
      .btn:active {
        transform: scale(0.97);
      }
      .btn svg {
        width: 15px;
        height: 15px;
        flex-shrink: 0;
      }

      .btn-primary {
        background: var(--accent);
        border-color: var(--accent);
        color: #ffffff;
      }
      .btn-primary:hover {
        opacity: 0.9;
        background: var(--accent);
        border-color: var(--accent);
      }

      .btn-danger {
        color: var(--danger);
        border-color: var(--danger-muted);
        background: var(--danger-muted);
      }
      .btn-danger:hover {
        background: var(--danger);
        border-color: var(--danger);
        color: #ffffff;
      }

      .btn-ghost {
        border: none;
        background: none;
        color: var(--text-secondary);
      }
      .btn-ghost:hover {
        background: var(--accent-hover);
        color: var(--text-primary);
      }

      .btn-block {
        width: 100%;
      }

      .btn:disabled,
      .btn-icon:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        pointer-events: none;
      }

      /* ============================================================
   Sidebar
   ============================================================ */
      .sidebar {
        width: var(--sidebar-width);
        background: var(--bg-surface);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        overflow: hidden;
        transition: transform var(--transition);
      }

      .sidebar-header {
        padding: 12px 14px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        flex-shrink: 0;
      }

      .search-box {
        position: relative;
      }
      .search-box svg {
        position: absolute;
        left: 10px;
        top: 50%;
        transform: translateY(-50%);
        width: 15px;
        height: 15px;
        color: var(--text-tertiary);
        pointer-events: none;
      }
      .search-input {
        width: 100%;
        height: 34px;
        padding: 0 10px 0 32px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        background: var(--bg-input);
        color: var(--text-primary);
        font-family: var(--font-ui);
        font-size: 13px;
        outline: none;
        transition: border-color var(--transition-fast);
      }
      .search-input::placeholder {
        color: var(--text-tertiary);
      }
      .search-input:focus {
        border-color: var(--accent);
      }

      .btn-new-file {
        height: 36px;
        border: 1px dashed var(--border);
        border-radius: var(--radius-md);
        background: none;
        color: var(--text-secondary);
        font-family: var(--font-ui);
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        transition:
          background var(--transition-fast),
          color var(--transition-fast),
          border-color var(--transition-fast);
        width: 100%;
      }
      .btn-new-file:hover {
        background: var(--accent-muted);
        border-color: var(--accent);
        color: var(--accent);
      }
      .btn-new-file svg {
        width: 15px;
        height: 15px;
      }

      .file-list {
        flex: 1;
        overflow-y: auto;
        padding: 4px 14px 12px;
      }

      .file-item {
        padding: 10px 12px;
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: background var(--transition-fast);
        display: flex;
        flex-direction: column;
        gap: 4px;
        margin: 5px 0;
        position: relative;
      }
      .file-item:hover {
        background: var(--accent-hover);
      }
      .file-item.active {
        background: var(--accent-muted);
      }
      .file-item.active::before {
        content: "";
        position: absolute;
        left: 0;
        top: 8px;
        bottom: 8px;
        width: 3px;
        border-radius: 0 2px 2px 0;
        background: var(--accent);
      }

      .file-item-title {
        font-family: var(--font-mono);
        font-size: 13px;
        font-weight: 500;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .file-item-title-text {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        min-width: 0;
        flex: 1;
      }

      .file-item-title .unsaved-mark {
        color: var(--warning);
        font-size: 18px;
        line-height: 1;
        flex-shrink: 0;
      }

      .file-item-meta {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: var(--text-tertiary);
      }

      .file-item-meta .filename-tag {
        font-family: var(--font-mono);
        font-size: 11px;
        background: var(--accent-muted);
        color: var(--accent);
        padding: 1px 6px;
        border-radius: 3px;
      }

      .file-item-actions {
        display: flex;
        align-items: center;
        gap: 2px;
        flex-shrink: 0;
        opacity: 0;
        transition: opacity var(--transition-fast);
      }
      .file-item:hover .file-item-actions,
      .file-item.active .file-item-actions {
        opacity: 1;
      }
      .file-item-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        border: none;
        background: none;
        color: var(--text-tertiary);
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition:
          background var(--transition-fast),
          color var(--transition-fast);
        padding: 0;
      }
      .file-item-btn:hover {
        background: var(--bg-overlay);
        color: var(--text-primary);
      }
      .file-item-btn[data-action="delete"]:hover {
        color: var(--danger);
        background: var(--danger-muted);
      }
      .file-item-btn svg {
        width: 14px;
        height: 14px;
      }

      .file-list-empty {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 48px 16px;
        text-align: center;
        color: var(--text-tertiary);
      }
      .file-list-empty svg {
        width: 40px;
        height: 40px;
        margin-bottom: 12px;
        opacity: 0.4;
      }

      .file-divider {
        height: 0;
        border: none;
        border-top: 1px dashed var(--border-muted);
        margin: 0 6px;
      }
      .file-list-empty p {
        font-size: 13px;
      }

      /* ============================================================
   Editor Panel
   ============================================================ */
      .editor-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
        background: var(--bg-surface);
      }

      .editor-empty {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 12px;
        color: var(--text-tertiary);
        user-select: none;
      }
      .editor-empty svg {
        width: 56px;
        height: 56px;
        opacity: 0.2;
      }
      .editor-empty p {
        font-size: 14px;
      }
      .editor-empty .hint {
        font-size: 12px;
        font-family: var(--font-mono);
        background: var(--bg-elevated);
        padding: 4px 10px;
        border-radius: var(--radius-sm);
        border: 1px solid var(--border-muted);
      }

      .editor-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-height: 0;
        animation: editorFadeIn 0.25s ease;
      }

      @keyframes editorFadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      /* File Info Section */
      .file-info {
        padding: 16px 20px;
        background: var(--bg-surface);
        border-bottom: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        gap: 10px;
        flex-shrink: 0;
      }

      .info-row {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .info-label {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 12px;
        font-weight: 500;
        color: var(--text-tertiary);
        white-space: nowrap;
        flex-shrink: 0;
      }
      .info-label svg {
        width: 13px;
        height: 13px;
      }

      .info-value-readonly {
        font-family: var(--font-mono);
        font-size: 12px;
        color: var(--text-secondary);
        background: var(--bg-overlay);
        padding: 5px 10px;
        border-radius: var(--radius-sm);
        flex: 1;
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        border: 1px solid var(--border-muted);
        user-select: all;
      }

      .info-input {
        flex: 1;
        min-width: 0;
        height: 30px;
        padding: 0 10px;
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        background: var(--bg-input);
        color: var(--text-primary);
        font-family: var(--font-mono);
        font-size: 13px;
        outline: none;
        transition: border-color var(--transition-fast);
      }
      .info-input:focus {
        border-color: var(--accent);
      }

      .info-row-split {
        display: flex;
        gap: 16px;
      }
      .info-group {
        display: flex;
        align-items: center;
        gap: 10px;
        flex: 1;
        min-width: 0;
      }

      .btn-copy-url {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 30px;
        height: 30px;
        border: 1px solid var(--border);
        border-radius: var(--radius-sm);
        background: var(--bg-elevated);
        color: var(--text-secondary);
        cursor: pointer;
        transition:
          background var(--transition-fast),
          color var(--transition-fast),
          border-color var(--transition-fast);
        flex-shrink: 0;
      }
      .btn-copy-url:hover {
        border-color: var(--accent);
        color: var(--accent);
        background: var(--accent-muted);
      }
      .btn-copy-url.copied {
        border-color: var(--success);
        color: var(--success);
        background: var(--success-muted);
      }
      .btn-copy-url svg {
        width: 14px;
        height: 14px;
      }

      /* Editor Stats Bar */
      .editor-stats {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 8px 20px;
        background: var(--bg-surface);
        border-bottom: 1px solid var(--border-muted);
        font-size: 12px;
        color: var(--text-tertiary);
        flex-shrink: 0;
      }
      .editor-stats .stat-item {
        display: flex;
        align-items: center;
        gap: 5px;
        font-family: var(--font-mono);
        font-size: 11px;
      }
      .editor-stats .stat-item svg {
        width: 13px;
        height: 13px;
      }
      .editor-stats .unsaved-badge {
        display: flex;
        align-items: center;
        gap: 4px;
        color: var(--warning);
        font-weight: 500;
      }
      .editor-stats .unsaved-badge .dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background: var(--warning);
      }
      .stat-spacer {
        flex: 1;
      }

      /* Textarea */
      .editor-area {
        flex: 1;
        min-height: 0;
        padding: 0;
        position: relative;
      }

      #aceEditor {
        width: 100%;
        height: 100%;
        font-size: 14px;
        line-height: 1.7;
      }

      /* Editor Actions */
      .editor-actions {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 20px;
        background: var(--bg-surface);
        border-top: 1px solid var(--border);
        flex-shrink: 0;
      }
      .editor-actions .action-spacer {
        flex: 1;
      }

      /* ============================================================
   Mobile Overlay
   ============================================================ */
      .sidebar-overlay {
        display: none;
        position: fixed;
        inset: 0;
        background: var(--backdrop);
        z-index: 199;
        opacity: 0;
        transition: opacity var(--transition);
      }
      .sidebar-overlay.visible {
        opacity: 1;
      }

      /* ============================================================
   Mobile Back Button
   ============================================================ */
      .btn-back {
        display: none;
        background: none;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 6px;
        border-radius: var(--radius-sm);
        transition:
          background var(--transition-fast),
          color var(--transition-fast);
        flex-shrink: 0;
      }
      .btn-back:hover {
        background: var(--accent-hover);
        color: var(--text-primary);
      }

      .mobile-file-title {
        display: none;
        font-family: var(--font-mono);
        font-size: 13px;
        font-weight: 500;
        color: var(--text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        min-width: 0;
      }

      /* ============================================================
   Toast Notifications
   ============================================================ */
      .toast-container {
        position: fixed;
        top: 12px;
        right: 12px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 6px;
        pointer-events: none;
      }

      .toast {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: var(--radius-md);
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        color: var(--text-primary);
        font-size: 12px;
        box-shadow: var(--shadow-lg);
        pointer-events: auto;
        animation: toastIn 0.3s ease;
        white-space: nowrap;
      }
      .toast.toast-out {
        animation: toastOut 0.25s ease forwards;
      }
      .toast svg {
        width: 14px;
        height: 14px;
        flex-shrink: 0;
      }
      .toast.toast-success svg {
        color: var(--success);
      }
      .toast.toast-error svg {
        color: var(--danger);
      }
      .toast.toast-warning svg {
        color: var(--warning);
      }
      .toast.toast-info svg {
        color: var(--accent);
      }

      @keyframes toastIn {
        from {
          opacity: 0;
          transform: translateX(40px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      @keyframes toastOut {
        from {
          opacity: 1;
          transform: translateX(0);
        }
        to {
          opacity: 0;
          transform: translateX(40px);
        }
      }

      /* ============================================================
   Modal
   ============================================================ */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: var(--backdrop);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        opacity: 0;
        visibility: hidden;
        transition:
          opacity var(--transition),
          visibility var(--transition);
      }
      .modal-backdrop.visible {
        opacity: 1;
        visibility: visible;
      }

      .modal {
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        width: 100%;
        max-width: 420px;
        padding: 24px;
        transform: scale(0.95) translateY(8px);
        transition: transform var(--transition);
      }
      .modal-backdrop.visible .modal {
        transform: scale(1) translateY(0);
      }

      .modal-title {
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .modal-body {
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: 20px;
        line-height: 1.6;
      }

      .modal-body .file-name {
        font-family: var(--font-mono);
        color: var(--text-primary);
        background: var(--bg-overlay);
        padding: 1px 6px;
        border-radius: var(--radius-sm);
      }

      .modal-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
      }

      /* ============================================================
   Import Result Modal Content
   ============================================================ */
      .import-result {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-family: var(--font-mono);
        font-size: 13px;
      }
      .import-result .result-success {
        color: var(--success);
      }
      .import-result .result-warning {
        color: var(--warning);
      }
      .import-result .result-error {
        color: var(--danger);
      }

      /* ============================================================
   Responsive: Mobile (<768px)
   ============================================================ */
      @media (max-width: 767px) {
        .app-header {
          flex-wrap: wrap;
        }

        .header-row-1 {
          display: flex;
          align-items: center;
          gap: 8px;
          width: 100%;
        }

        .header-row-2 {
          display: flex;
          align-items: center;
          gap: 4px;
          width: 100%;
        }

        .header-left {
          flex: 1;
          min-width: 0;
        }
        .header-spacer {
          display: none;
        }

        .header-right {
          flex-shrink: 0;
        }

        .btn-menu {
          display: none;
        }
        .btn-back {
          display: none;
        }
        .mobile-file-title {
          display: none;
        }

        /* Mobile: editing mode */
        body.mobile-editing .btn-menu {
          display: none;
        }
        body.mobile-editing .btn-back {
          display: inline-flex;
        }
        body.mobile-editing .app-logo {
          display: none;
        }
        body.mobile-editing .status-dot {
          display: none;
        }
        body.mobile-editing .mobile-file-title {
          display: block;
        }

        .sidebar {
          position: fixed;
          top: 0;
          left: 0;
          bottom: 0;
          width: calc(100vw - 60px);
          max-width: 340px;
          z-index: 200;
          transform: translateX(-100%);
          box-shadow: var(--shadow-lg);
          transition: none;
        }
        .sidebar.open {
          transform: translateX(0);
          transition: transform var(--transition);
        }
        .sidebar-overlay.active {
          display: block;
        }

        .file-item {
          padding: 12px;
        }
        .file-item-actions {
          opacity: 1;
        }

        body:not(.mobile-editing) .editor-panel {
          display: none;
        }
        body:not(.mobile-editing) .sidebar {
          position: static;
          width: 100%;
          max-width: none;
          transform: none;
          border-right: none;
        }

        body.mobile-editing .sidebar {
          /* Keep sidebar as overlay in editing mode */
        }

        .info-input {
          font-size: 16px;
        }

        .editor-actions {
          flex-wrap: wrap;
        }
        .editor-actions .btn {
          flex: 1;
          min-width: 80px;
        }
        .editor-actions .action-spacer {
          display: none;
        }

        .file-info {
          padding: 12px 14px;
        }
        .editor-stats {
          padding: 8px 14px;
          flex-wrap: wrap;
          gap: 10px;
        }
        .editor-actions {
          padding: 10px 14px;
        }

        .info-label {
          font-size: 11px;
          min-width: 52px;
        }

        .info-row-split {
          flex-direction: column;
          gap: 10px;
        }
        .info-row-split .info-group {
          width: 100%;
        }
      }

      /* ============================================================
   Utilities
   ============================================================ */
      .visually-hidden {
        position: absolute;
        width: 1px;
        height: 1px;
        margin: -1px;
        padding: 0;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        border: 0;
      }

      .hidden {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Modal -->
    <div class="modal-backdrop" id="modalBackdrop">
      <div class="modal" role="dialog" aria-modal="true">
        <div class="modal-title" id="modalTitle"></div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-actions" id="modalActions"></div>
      </div>
    </div>

    <!-- Sidebar Overlay (mobile) -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- App Shell -->
    <div class="app-shell">
      <!-- Header -->
      <header class="app-header" role="banner">
        <div class="header-row-1">
          <div class="header-left">
            <button class="btn-menu" id="btnMenu" aria-label="打开菜单">
              <i data-lucide="menu" style="width: 20px; height: 20px"></i>
            </button>
            <button class="btn-back" id="btnBack" aria-label="返回列表">
              <i data-lucide="arrow-left" style="width: 20px; height: 20px"></i>
            </button>
            <span class="app-logo">CF-WORKER-TEXT2KV</span>
            <span class="mobile-file-title" id="mobileFileTitle"></span>
            <span class="status-dot" title="服务在线"></span>
          </div>
          <div class="header-right">
            <button
              class="btn-icon"
              id="btnExport"
              title="导出数据"
              aria-label="导出数据"
            >
              <i data-lucide="download"></i>
            </button>
            <button
              class="btn-icon"
              id="btnImport"
              title="导入数据"
              aria-label="导入数据"
            >
              <i data-lucide="upload"></i>
            </button>
            <button
              class="btn-icon"
              id="btnTheme"
              title="切换主题"
              aria-label="切换主题"
            >
              <i data-lucide="moon" id="themeIcon"></i>
            </button>
          </div>
        </div>
      </header>

      <!-- Body -->
      <div class="app-body">
        <!-- Sidebar -->
        <aside
          class="sidebar"
          id="sidebar"
          role="navigation"
          aria-label="文件列表"
        >
          <div class="sidebar-header">
            <div class="search-box">
              <i data-lucide="search"></i>
              <input
                type="text"
                class="search-input"
                id="searchInput"
                placeholder="搜索文件..."
                aria-label="搜索文件"
              />
            </div>
            <button class="btn-new-file" id="btnNewFile">
              <i data-lucide="plus"></i>
              新建文件
            </button>
          </div>
          <div class="file-list" id="fileList" role="list"></div>
        </aside>

        <!-- Editor -->
        <main class="editor-panel" id="editorPanel">
          <!-- Empty state -->
          <div class="editor-empty" id="editorEmpty">
            <i data-lucide="file-text"></i>
            <p>选择文件开始编辑</p>
            <span class="hint">Ctrl+S / Cmd+S 保存</span>
          </div>

          <!-- Editor content (hidden initially) -->
          <div class="editor-content hidden" id="editorContent">
            <!-- File Info -->
            <div class="file-info">
              <div class="info-row" style="display: none">
                <span class="info-label">KV Key</span>
                <span class="info-value-readonly" id="fileIdDisplay"></span>
              </div>
              <div class="info-row info-row-split">
                <div class="info-group">
                  <span class="info-label"><i data-lucide="tag"></i>标题</span>
                  <input
                    type="text"
                    class="info-input"
                    id="titleInput"
                    placeholder="文件描述（必填）"
                    aria-label="文件标题"
                  />
                </div>
                <div class="info-group">
                  <span class="info-label"
                    ><i data-lucide="file-text"></i>文件名</span
                  >
                  <input
                    type="text"
                    class="info-input"
                    id="filenameInput"
                    placeholder="example.yaml"
                    aria-label="文件名"
                  />
                  <button
                    class="btn-copy-url"
                    id="btnCopyUrl"
                    title="复制访问链接"
                    aria-label="复制访问链接"
                  >
                    <i data-lucide="copy"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- Stats Bar -->
            <div class="editor-stats">
              <div class="stat-item">
                <i data-lucide="file-text"></i>
                <span id="lineCount">0 行</span>
              </div>
              <div class="stat-item">
                <i data-lucide="edit-3"></i>
                <span id="charCount">0 字符</span>
              </div>
              <div class="stat-spacer"></div>
              <button
                class="btn btn-ghost"
                id="btnFormat"
                title="格式化内容"
                style="height: 24px; padding: 0 8px; font-size: 11px"
              >
                <i data-lucide="align-left"></i>
                格式化
              </button>
              <div class="unsaved-badge hidden" id="unsavedBadge">
                <span class="dot"></span>
                <span>未保存</span>
              </div>
            </div>

            <!-- Editor -->
            <div class="editor-area">
              <div id="aceEditor"></div>
            </div>

            <!-- Actions -->
            <div class="editor-actions">
              <button class="btn" id="btnRefresh">
                <i data-lucide="refresh-cw"></i>
                刷新
              </button>
              <span class="action-spacer"></span>
              <button class="btn btn-primary" id="btnSave">
                <i data-lucide="save"></i>
                保存
              </button>
              <button class="btn btn-danger" id="btnDelete">
                <i data-lucide="trash-2"></i>
                删除
              </button>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Hidden file input for import -->
    <input
      type="file"
      id="importFileInput"
      accept=".json"
      class="visually-hidden"
    />

    <script>
      /* ============================================================
   Mock Data
   ============================================================ */
      const mockFiles = [
        {
          id: "a3f2c8d1-4e5b-6c7d-8e9f-0a1b2c3d4e5f",
          filename: "proxy-config.yaml",
          title: "代理配置",
          contentType: "text/plain",
          content:
            'proxies:\n  - name: "HK-01"\n    type: ss\n    server: hk1.example.com\n    port: 8388\n    cipher: aes-256-gcm\n    password: "your-password"\n\n  - name: "US-01"\n    type: vmess\n    server: us1.example.com\n    port: 443\n    uuid: "12345678-abcd-efgh-ijkl-123456789012"\n    alterId: 0\n    cipher: auto\n    tls: true',
          createdAt: new Date(Date.now() - 86400000 * 3).toISOString(),
          updatedAt: new Date(Date.now() - 120000).toISOString(),
        },
        {
          id: "b4e3d9f2-5a6c-7d8e-9f0a-1b2c3d4e5f6a",
          filename: "api-endpoints.json",
          title: "API 接口文档",
          contentType: "text/plain",
          content:
            '{\n  "endpoints": [\n    {\n      "method": "GET",\n      "path": "/api/users",\n      "description": "List all users"\n    },\n    {\n      "method": "POST",\n      "path": "/api/users",\n      "description": "Create a new user"\n    }\n  ]\n}',
          createdAt: new Date(Date.now() - 86400000 * 7).toISOString(),
          updatedAt: new Date(Date.now() - 3600000).toISOString(),
        },
        {
          id: "c5f4e0a3-6b7d-8e9f-0a1b-2c3d4e5f6a7b",
          filename: "subscription-list.txt",
          title: "节点订阅列表",
          contentType: "text/plain",
          content:
            "ss://YWVzLTI1Ni1nY206cGFzc3dvcmQ@server1.example.com:8388#HK-Node-01\nss://YWVzLTI1Ni1nY206cGFzc3dvcmQ@server2.example.com:8388#US-Node-01\nvmess://eyJ2IjoiMiIsInBzIjoiSlAtTm9kZS0wMSJ9",
          createdAt: new Date(Date.now() - 86400000 * 14).toISOString(),
          updatedAt: new Date(Date.now() - 86400000).toISOString(),
        },
        {
          id: "d6a5f1b4-7c8e-9f0a-1b2c-3d4e5f6a7b8c",
          filename: "nginx-config.conf",
          title: "Nginx 反向代理",
          contentType: "text/plain",
          content:
            "server {\n    listen 80;\n    server_name example.com;\n\n    location / {\n        proxy_pass http://localhost:3000;\n        proxy_set_header Host $host;\n        proxy_set_header X-Real-IP $remote_addr;\n    }\n\n    location /api {\n        proxy_pass http://localhost:8080;\n        proxy_set_header Host $host;\n    }\n}",
          createdAt: new Date(Date.now() - 86400000 * 2).toISOString(),
          updatedAt: new Date(Date.now() - 86400000 * 2).toISOString(),
        },
      ];

      /* ============================================================
   Application State
   ============================================================ */
      const state = {
        files: JSON.parse(JSON.stringify(mockFiles)),
        selectedFileId: null,
        originalContent: null,
        originalFilename: null,
        originalTitle: null,
        isDirty: false,
        isMobileEditing: false,
        sidebarOpen: false,
      };

      /* ============================================================
   DOM References
   ============================================================ */
      const $ = (sel) => document.querySelector(sel);
      const $$ = (sel) => document.querySelectorAll(sel);

      const dom = {
        toastContainer: $("#toastContainer"),
        modalBackdrop: $("#modalBackdrop"),
        modalTitle: $("#modalTitle"),
        modalBody: $("#modalBody"),
        modalActions: $("#modalActions"),
        sidebarOverlay: $("#sidebarOverlay"),
        sidebar: $("#sidebar"),
        searchInput: $("#searchInput"),
        fileList: $("#fileList"),
        editorPanel: $("#editorPanel"),
        editorEmpty: $("#editorEmpty"),
        editorContent: $("#editorContent"),
        fileIdDisplay: $("#fileIdDisplay"),
        filenameInput: $("#filenameInput"),
        titleInput: $("#titleInput"),
        lineCount: $("#lineCount"),
        charCount: $("#charCount"),
        unsavedBadge: $("#unsavedBadge"),
        mobileFileTitle: $("#mobileFileTitle"),
        btnMenu: $("#btnMenu"),
        btnBack: $("#btnBack"),
        btnNewFile: $("#btnNewFile"),
        btnCopyUrl: $("#btnCopyUrl"),
        btnRefresh: $("#btnRefresh"),
        btnSave: $("#btnSave"),
        btnDelete: $("#btnDelete"),
        btnExport: $("#btnExport"),
        btnImport: $("#btnImport"),
        btnTheme: $("#btnTheme"),
        btnFormat: $("#btnFormat"),
        themeIcon: $("#themeIcon"),
        importFileInput: $("#importFileInput"),
      };

      /* ============================================================
   Ace Editor Setup
   ============================================================ */
      let aceEditor;

      function initAceEditor() {
        aceEditor = ace.edit("aceEditor");
        aceEditor.setOptions({
          fontFamily: "'JetBrains Mono', 'Fira Code', monospace",
          fontSize: 14,
          showPrintMargin: false,
          tabSize: 2,
          useSoftTabs: true,
          wrap: true,
          showGutter: true,
          highlightActiveLine: true,
          scrollPastEnd: 0.3,
        });
        aceEditor.renderer.setScrollMargin(12, 12, 0, 0);
        aceEditor.renderer.setPadding(16);
        aceEditor.commands.addCommand({
          name: "save",
          bindKey: { win: "Ctrl-S", mac: "Cmd-S" },
          exec: () => {
            if (state.selectedFileId) saveFile();
          },
        });
        applyAceTheme();
      }

      function applyAceTheme() {
        const theme = document.documentElement.getAttribute("data-theme");
        aceEditor.setTheme(
          theme === "dark" ? "ace/theme/one_dark" : "ace/theme/chrome",
        );
      }

      function detectAceMode(title) {
        if (!title) return "ace/mode/text";
        const ext = title.split(".").pop().toLowerCase();
        const modeMap = {
          json: "ace/mode/json",
          yaml: "ace/mode/yaml",
          yml: "ace/mode/yaml",
          js: "ace/mode/javascript",
          ts: "ace/mode/typescript",
          html: "ace/mode/html",
          css: "ace/mode/css",
          xml: "ace/mode/xml",
          md: "ace/mode/markdown",
          sh: "ace/mode/sh",
          bash: "ace/mode/sh",
          conf: "ace/mode/text",
          txt: "ace/mode/text",
          toml: "ace/mode/toml",
          ini: "ace/mode/ini",
          py: "ace/mode/python",
        };
        return modeMap[ext] || "ace/mode/text";
      }

      function getEditorValue() {
        return aceEditor ? aceEditor.getValue() : "";
      }

      function setEditorValue(val, title) {
        if (!aceEditor) return;
        aceEditor.setValue(val, -1);
        aceEditor.session.setMode(detectAceMode(title));
        aceEditor.clearSelection();
      }

      function formatContent() {
        if (!aceEditor || !state.selectedFileId) return;
        const file = state.files.find((f) => f.id === state.selectedFileId);
        if (!file) return;

        const text = getEditorValue();
        const filename = dom.filenameInput.value || file.filename || "";
        const ext = filename.split(".").pop().toLowerCase();

        try {
          if (ext === "json") {
            const parsed = JSON.parse(text);
            const formatted = JSON.stringify(parsed, null, 2);
            aceEditor.setValue(formatted, -1);
            aceEditor.clearSelection();
            showToast("JSON 格式化完成", "success");
          } else if (ext === "yaml" || ext === "yml") {
            const parsed = jsyaml.load(text);
            const formatted = jsyaml.dump(parsed, {
              indent: 2,
              lineWidth: -1,
              noRefs: true,
            });
            aceEditor.setValue(formatted, -1);
            aceEditor.clearSelection();
            showToast("YAML 格式化完成", "success");
          } else {
            showToast("仅支持 JSON 和 YAML 格式化", "warning");
          }
        } catch (e) {
          showToast("格式化失败: " + e.message, "error");
        }
      }

      /* ============================================================
   Theme Management
   ============================================================ */
      function initTheme() {
        const saved = localStorage.getItem("text-store-theme") || "dark";
        document.documentElement.setAttribute("data-theme", saved);
        updateThemeIcon(saved);
      }

      function toggleTheme() {
        const current = document.documentElement.getAttribute("data-theme");
        const next = current === "dark" ? "light" : "dark";
        document.documentElement.setAttribute("data-theme", next);
        localStorage.setItem("text-store-theme", next);
        updateThemeIcon(next);
        if (aceEditor) applyAceTheme();
        lucide.createIcons();
      }

      function updateThemeIcon(theme) {
        dom.themeIcon.setAttribute(
          "data-lucide",
          theme === "dark" ? "moon" : "sun",
        );
        lucide.createIcons();
      }

      /* ============================================================
   Toast System
   ============================================================ */
      function showToast(message, type = "info") {
        const iconMap = {
          success: "check-circle-2",
          error: "x-circle",
          warning: "alert-triangle",
          info: "info",
        };
        const toast = document.createElement("div");
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `<i data-lucide="${iconMap[type] || "info"}"></i><span>${message}</span>`;
        dom.toastContainer.appendChild(toast);
        lucide.createIcons({ nodes: [toast] });

        setTimeout(() => {
          toast.classList.add("toast-out");
          toast.addEventListener("animationend", () => toast.remove());
        }, 2800);
      }

      /* ============================================================
   Modal System
   ============================================================ */
      function showModal({ title, body, actions }) {
        dom.modalTitle.textContent = title;
        if (typeof body === "string") {
          dom.modalBody.innerHTML = body;
        } else {
          dom.modalBody.textContent = "";
          dom.modalBody.appendChild(body);
        }
        dom.modalActions.textContent = "";
        actions.forEach(({ label, className = "", onClick }) => {
          const btn = document.createElement("button");
          btn.className = `btn ${className}`;
          btn.textContent = label;
          btn.addEventListener("click", () => {
            hideModal();
            if (onClick) onClick();
          });
          dom.modalActions.appendChild(btn);
        });
        dom.modalBackdrop.classList.add("visible");
      }

      function hideModal() {
        dom.modalBackdrop.classList.remove("visible");
      }

      /* ============================================================
   Utility Functions
   ============================================================ */
      function timeAgo(dateStr) {
        const now = Date.now();
        const diff = now - new Date(dateStr).getTime();
        const seconds = Math.floor(diff / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);

        if (seconds < 60) return "刚刚";
        if (minutes < 60) return `${minutes} 分钟前`;
        if (hours < 24) return `${hours} 小时前`;
        if (days < 7) return `${days} 天前`;
        if (days < 30) return `${Math.floor(days / 7)} 周前`;
        return `${Math.floor(days / 30)} 个月前`;
      }

      function formatSize(str) {
        const bytes = new Blob([str]).size;
        if (bytes < 1024) return `${bytes} B`;
        if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
        return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
      }

      function generateUUID() {
        return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, (c) => {
          const r = (Math.random() * 16) | 0;
          return (c === "x" ? r : (r & 0x3) | 0x8).toString(16);
        });
      }

      function isMobile() {
        return window.innerWidth < 768;
      }

      /* ============================================================
   File List Rendering
   ============================================================ */
      function renderFileList(filter = "") {
        const query = filter.toLowerCase().trim();
        let files = [...state.files].sort(
          (a, b) => new Date(b.updatedAt) - new Date(a.updatedAt),
        );

        if (query) {
          files = files.filter(
            (f) =>
              f.filename.toLowerCase().includes(query) ||
              (f.title && f.title.toLowerCase().includes(query)),
          );
        }

        if (files.length === 0) {
          dom.fileList.innerHTML = `
      <div class="file-list-empty">
        <i data-lucide="search"></i>
        <p>${query ? "没有匹配的文件" : "暂无文件"}</p>
      </div>`;
          lucide.createIcons({ nodes: [dom.fileList] });
          return;
        }

        dom.fileList.innerHTML = files
          .map((f, index) => {
            const isActive = f.id === state.selectedFileId;
            const isDirty = isActive && state.isDirty;
            const divider =
              index < files.length - 1 ? '<hr class="file-divider">' : "";
            return `
      <div class="file-item ${isActive ? "active" : ""}" data-id="${f.id}" role="listitem" tabindex="0">
        <div class="file-item-title">
          <span class="file-item-title-text">${f.title || f.filename}</span>
          ${isDirty ? '<span class="unsaved-mark">*</span>' : ""}
          <div class="file-item-actions">
            <button class="file-item-btn" data-action="copy" data-filename="${f.filename}" title="复制访问链接"><i data-lucide="copy"></i></button>
            <button class="file-item-btn" data-action="delete" data-file-id="${f.id}" title="删除文件"><i data-lucide="trash-2"></i></button>
          </div>
        </div>
        <div class="file-item-meta">
          <span>${timeAgo(f.updatedAt)}</span>
          <span>${formatSize(f.content)}</span>
          <span class="filename-tag">/${f.filename}</span>
        </div>
      </div>${divider}`;
          })
          .join("");

        lucide.createIcons({ nodes: [dom.fileList] });
      }

      /* ============================================================
   File Selection & Editor
   ============================================================ */
      function selectFile(fileId) {
        if (state.isDirty && state.selectedFileId) {
          showModal({
            title: "未保存的更改",
            body: "当前文件有未保存的更改，是否放弃？",
            actions: [
              { label: "取消", className: "btn-ghost" },
              {
                label: "放弃更改",
                className: "btn-danger",
                onClick: () => forceSelectFile(fileId),
              },
            ],
          });
          return;
        }
        forceSelectFile(fileId);
      }

      function forceSelectFile(fileId) {
        const file = state.files.find((f) => f.id === fileId);
        if (!file) return;

        state.selectedFileId = fileId;
        state.originalContent = file.content;
        state.originalFilename = file.filename;
        state.originalTitle = file.title;
        state.isDirty = false;

        // Show editor
        dom.editorEmpty.classList.add("hidden");
        dom.editorContent.classList.remove("hidden");

        // Populate fields
        dom.fileIdDisplay.textContent = file.id;
        dom.filenameInput.value = file.filename;
        dom.titleInput.value = file.title || "";
        setEditorValue(file.content, file.filename);
        dom.mobileFileTitle.textContent = file.title || file.filename;

        updateStats();
        updateUnsavedBadge();
        renderFileList(dom.searchInput.value);

        // Mobile: enter editing mode
        if (isMobile()) {
          enterMobileEditing();
        }

        closeSidebar();
      }

      function deselectFile() {
        state.selectedFileId = null;
        state.isDirty = false;
        dom.editorEmpty.classList.remove("hidden");
        dom.editorContent.classList.add("hidden");
        renderFileList(dom.searchInput.value);
      }

      /* ============================================================
   Stats Update
   ============================================================ */
      function updateStats() {
        const text = getEditorValue();
        const lines = text ? text.split("\n").length : 0;
        const chars = text.length;
        dom.lineCount.textContent = `${lines} 行`;
        dom.charCount.textContent = `${chars.toLocaleString()} 字符`;
      }

      /* ============================================================
   Dirty Tracking
   ============================================================ */
      function checkDirty() {
        const file = state.files.find((f) => f.id === state.selectedFileId);
        if (!file) return;

        const contentChanged = getEditorValue() !== state.originalContent;
        const filenameChanged =
          dom.filenameInput.value !== state.originalFilename;
        const titleChanged =
          dom.titleInput.value !== (state.originalTitle || "");

        state.isDirty = contentChanged || filenameChanged || titleChanged;
        updateUnsavedBadge();
        renderFileList(dom.searchInput.value);
      }

      function updateUnsavedBadge() {
        if (state.isDirty) {
          dom.unsavedBadge.classList.remove("hidden");
        } else {
          dom.unsavedBadge.classList.add("hidden");
        }
      }

      /* ============================================================
   File Operations
   ============================================================ */
      function createNewFile() {
        const newFile = {
          id: generateUUID(),
          filename: "未命名文件.txt",
          title: "新建文件",
          contentType: "text/plain",
          content: "",
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString(),
        };
        state.files.unshift(newFile);
        showToast("文件已创建", "success");
        forceSelectFile(newFile.id);
      }

      function saveFile() {
        const file = state.files.find((f) => f.id === state.selectedFileId);
        if (!file) return;

        // Filename uniqueness check
        const newFilename = dom.filenameInput.value.trim();
        if (newFilename) {
          const conflict = state.files.find(
            (f) => f.filename === newFilename && f.id !== file.id,
          );
          if (conflict) {
            showToast(`文件名 "${newFilename}" 已被使用`, "error");
            return;
          }
        }

        file.filename = newFilename || "未命名文件.txt";
        file.title = dom.titleInput.value.trim() || file.filename;
        file.content = getEditorValue();
        file.updatedAt = new Date().toISOString();

        state.originalContent = file.content;
        state.originalFilename = file.filename;
        state.originalTitle = file.title;
        state.isDirty = false;

        updateUnsavedBadge();
        renderFileList(dom.searchInput.value);
        dom.mobileFileTitle.textContent = file.title || file.filename;
        showToast("文件已保存", "success");
      }

      function refreshFile() {
        const file = state.files.find((f) => f.id === state.selectedFileId);
        if (!file) return;

        if (state.isDirty) {
          showModal({
            title: "刷新确认",
            body: "当前有未保存的更改，刷新将丢失所有更改。",
            actions: [
              { label: "取消", className: "btn-ghost" },
              {
                label: "刷新",
                className: "btn-primary",
                onClick: () => {
                  forceSelectFile(file.id);
                  showToast("内容已刷新", "info");
                },
              },
            ],
          });
          return;
        }
        forceSelectFile(file.id);
        showToast("内容已刷新", "info");
      }

      function deleteFile() {
        const file = state.files.find((f) => f.id === state.selectedFileId);
        if (!file) return;

        showModal({
          title: "确认删除",
          body: `确定要删除文件 <span class="file-name">${file.title || file.filename}</span> 吗？此操作不可撤销。`,
          actions: [
            { label: "取消", className: "btn-ghost" },
            {
              label: "删除",
              className: "btn-danger",
              onClick: () => {
                state.files = state.files.filter((f) => f.id !== file.id);
                deselectFile();
                if (isMobile()) exitMobileEditing();
                showToast("文件已删除", "success");
              },
            },
          ],
        });
      }

      /* ============================================================
   Import / Export
   ============================================================ */
      function exportData() {
        const data = {
          version: "1.0",
          exportedAt: new Date().toISOString(),
          files: state.files.map((f) => ({
            ...f,
            content: btoa(unescape(encodeURIComponent(f.content))),
            encoding: "base64",
          })),
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `text-store-export-${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
        showToast("数据已导出", "success");
      }

      function importData() {
        dom.importFileInput.click();
      }

      function handleImportFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);
            if (!data.version || !data.files || !Array.isArray(data.files)) {
              showToast("文件格式不正确", "error");
              return;
            }

            let imported = 0,
              skipped = 0,
              failed = 0;

            data.files.forEach((f) => {
              try {
                let content = f.content;
                if (f.encoding === "base64") {
                  content = decodeURIComponent(escape(atob(content)));
                }

                const fname = f.filename || f.title || "未命名文件.txt";
                if (state.files.find((ef) => ef.filename === fname)) {
                  skipped++;
                  return;
                }

                state.files.push({
                  id: f.id || generateUUID(),
                  filename: fname,
                  title: f.filename ? f.title || fname : fname,
                  contentType: f.contentType || "text/plain",
                  content: content,
                  createdAt: f.createdAt || new Date().toISOString(),
                  updatedAt: f.updatedAt || new Date().toISOString(),
                });
                imported++;
              } catch {
                failed++;
              }
            });

            renderFileList(dom.searchInput.value);

            const resultEl = document.createElement("div");
            resultEl.className = "import-result";
            resultEl.innerHTML = [
              imported > 0
                ? `<div class="result-success">+ 成功导入 ${imported} 个文件</div>`
                : "",
              skipped > 0
                ? `<div class="result-warning">! 跳过 ${skipped} 个文件（别名冲突）</div>`
                : "",
              failed > 0
                ? `<div class="result-error">x 失败 ${failed} 个文件（解码错误）</div>`
                : "",
            ]
              .filter(Boolean)
              .join("");

            showModal({
              title: "导入完成",
              body: resultEl,
              actions: [{ label: "确定", className: "btn-primary" }],
            });
          } catch {
            showToast("JSON 解析失败", "error");
          }
        };
        reader.readAsText(file);
        event.target.value = "";
      }

      /* ============================================================
   Copy Alias URL
   ============================================================ */
      function copyFileUrl(filename) {
        if (!filename) {
          filename = dom.filenameInput ? dom.filenameInput.value.trim() : "";
        }
        if (!filename) {
          showToast("文件名为空", "warning");
          return;
        }
        const url = `${window.location.origin}/f/${filename}`;
        navigator.clipboard
          .writeText(url)
          .then(() => {
            if (dom.btnCopyUrl) {
              dom.btnCopyUrl.classList.add("copied");
              setTimeout(() => dom.btnCopyUrl.classList.remove("copied"), 1500);
            }
            showToast("访问链接已复制", "success");
          })
          .catch(() => {
            showToast("复制失败", "error");
          });
      }

      /* ============================================================
   Mobile Sidebar
   ============================================================ */
      function openSidebar() {
        state.sidebarOpen = true;
        dom.sidebar.classList.add("open");
        dom.sidebarOverlay.classList.add("active");
        requestAnimationFrame(() =>
          dom.sidebarOverlay.classList.add("visible"),
        );
      }

      function closeSidebar() {
        state.sidebarOpen = false;
        dom.sidebar.classList.remove("open");
        dom.sidebarOverlay.classList.remove("visible");
        setTimeout(() => dom.sidebarOverlay.classList.remove("active"), 200);
      }

      function enterMobileEditing() {
        state.isMobileEditing = true;
        document.body.classList.add("mobile-editing");
        requestAnimationFrame(() => {
          if (aceEditor) aceEditor.resize();
        });
      }

      function exitMobileEditing() {
        if (state.isDirty) {
          showModal({
            title: "未保存的更改",
            body: "当前文件有未保存的更改，是否放弃？",
            actions: [
              { label: "取消", className: "btn-ghost" },
              {
                label: "放弃更改",
                className: "btn-danger",
                onClick: () => {
                  state.isDirty = false;
                  forceExitMobileEditing();
                },
              },
            ],
          });
          return;
        }
        forceExitMobileEditing();
      }

      function forceExitMobileEditing() {
        state.isMobileEditing = false;
        document.body.classList.remove("mobile-editing");
        deselectFile();
      }

      /* ============================================================
   Keyboard Shortcuts
   ============================================================ */
      function handleKeyDown(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === "s") {
          e.preventDefault();
          if (state.selectedFileId) saveFile();
        }
      }

      /* ============================================================
   Beforeunload Guard
   ============================================================ */
      function handleBeforeUnload(e) {
        if (state.isDirty) {
          e.preventDefault();
          e.returnValue = "";
        }
      }

      /* ============================================================
   Event Binding
   ============================================================ */
      function bindEvents() {
        // Header
        dom.btnMenu.addEventListener("click", () => {
          if (state.sidebarOpen) closeSidebar();
          else openSidebar();
        });
        dom.btnBack.addEventListener("click", exitMobileEditing);
        dom.btnTheme.addEventListener("click", toggleTheme);
        dom.btnExport.addEventListener("click", exportData);
        dom.btnImport.addEventListener("click", importData);
        dom.importFileInput.addEventListener("change", handleImportFile);

        // Sidebar overlay
        dom.sidebarOverlay.addEventListener("click", closeSidebar);

        // Search
        dom.searchInput.addEventListener("input", () => {
          renderFileList(dom.searchInput.value);
        });

        // New file
        dom.btnNewFile.addEventListener("click", createNewFile);

        // File list delegation
        dom.fileList.addEventListener("click", (e) => {
          const actionBtn = e.target.closest(".file-item-btn");
          if (actionBtn) {
            e.stopPropagation();
            const action = actionBtn.dataset.action;
            if (action === "copy") {
              copyFileUrl(actionBtn.dataset.filename);
            } else if (action === "delete") {
              const fileId = actionBtn.dataset.fileId;
              const file = state.files.find((f) => f.id === fileId);
              if (file) {
                showModal({
                  title: "确认删除",
                  body: `确定要删除文件 <span class="file-name">${file.title || file.filename}</span> 吗？此操作不可撤销。`,
                  actions: [
                    { label: "取消", className: "btn-ghost" },
                    {
                      label: "删除",
                      className: "btn-danger",
                      onClick: () => {
                        state.files = state.files.filter(
                          (f) => f.id !== fileId,
                        );
                        if (state.selectedFileId === fileId) {
                          deselectFile();
                          if (isMobile()) forceExitMobileEditing();
                        }
                        renderFileList(dom.searchInput.value);
                        showToast("文件已删除", "success");
                      },
                    },
                  ],
                });
              }
            }
            return;
          }
          const item = e.target.closest(".file-item");
          if (item) selectFile(item.dataset.id);
        });
        dom.fileList.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            const item = e.target.closest(".file-item");
            if (item) selectFile(item.dataset.id);
          }
        });

        // Editor change tracking via Ace
        aceEditor.on("change", () => {
          updateStats();
          checkDirty();
        });
        dom.titleInput.addEventListener("input", checkDirty);
        dom.filenameInput.addEventListener("input", () => {
          checkDirty();
          if (aceEditor)
            aceEditor.session.setMode(detectAceMode(dom.filenameInput.value));
        });

        // Editor actions
        dom.btnSave.addEventListener("click", saveFile);
        dom.btnRefresh.addEventListener("click", refreshFile);
        dom.btnDelete.addEventListener("click", deleteFile);
        dom.btnCopyUrl.addEventListener("click", () => copyFileUrl());
        dom.btnFormat.addEventListener("click", formatContent);

        // Keyboard
        document.addEventListener("keydown", handleKeyDown);
        window.addEventListener("beforeunload", handleBeforeUnload);

        // Modal backdrop click to close
        dom.modalBackdrop.addEventListener("click", (e) => {
          if (e.target === dom.modalBackdrop) hideModal();
        });

        // Layout breakpoint: use matchMedia instead of resize to avoid
        // false triggers from mobile address bar / keyboard changes
        const mobileQuery = window.matchMedia("(max-width: 767px)");
        mobileQuery.addEventListener("change", (e) => {
          if (!e.matches && state.isMobileEditing) {
            document.body.classList.remove("mobile-editing");
            state.isMobileEditing = false;
          }
          if (!e.matches && state.sidebarOpen) {
            closeSidebar();
          }
        });
      }

      /* ============================================================
   Initialize
   ============================================================ */
      function init() {
        initTheme();
        initAceEditor();
        bindEvents();
        renderFileList();
        lucide.createIcons();

        // Auto-select first file on desktop
        if (!isMobile() && state.files.length > 0) {
          const sorted = [...state.files].sort(
            (a, b) => new Date(b.updatedAt) - new Date(a.updatedAt),
          );
          forceSelectFile(sorted[0].id);
        }
      }

      document.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
